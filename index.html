<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>OctoPlay</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type='text/css'>
        .camera-preview {
            border: 1px solid black;
            width: 200px;
            height:200px;
        }
        .current-layer {
            font-size: 150%;
            text-align: center;
        }
        .current-percent {
            font-size: 500%;
            text-align: center;
        }
        .current-time-label {
            font-size: 100%;
            text-align: center;
        }
        .current-time-amount {
            font-size: 200%;
            text-align: center;
        }




        /* == start file upload stuff */
        .btn-file {
            position: relative;
            overflow: hidden;
        }
        .btn-file input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 999px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            background: white;
            cursor: inherit;
            display: block;
        }
        /* == end file upload stuff */

    </style>
  </head>
  <body>

<nav class='navbar navbar-default' role='navigation'>
    <div class='container-fluid'>
        <div class='navbar-header'>
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navdown">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <span class="navbar-brand">OctoPlay</span>
        </div>

        <div class="collapse navbar-collapse" id="navdown">

          <ul class="nav navbar-nav navbar-right">
              <li><a href="#" id='login-menu'>Login</a></li>
              <li><a href="#" id='home-menu'>Home</a></li>
              <li><a href="#" id='manual-menu'>Manual Control</a></li>
              <li><a href="#" id='camera-menu'>Camera</a></li>
              <li><a href="#" id='settings-menu'>Settings</a></li>
              <li><a href="#" id='about-menu'>About OctoPlay</a></li>
          </ul>
      </div>

    </div>
</nav>



<div class='container-fluid'>

    <div class='row'>
        <div class='col-md-4'>
            <div class='panel panel-default'>
                <p>current temp: <b id='sidebar-status-temp'>-99C</b></p>
                <p>state: <b id='sidebar-status-state'>standby</b></p>
            </div>
        </div>


        <div class='col-md-8'>

<div class='row mode-panel' id='standby-panel'>
    <div class='col-md-12'>
        <div class='panel panel-default'>
            <div class='panel-heading'>Print Queue</div>
            <div class='panel-body'>


                <ul class='list-group print-queue'>
                    <!--
                    <li class='list-group-item active'>
                        <span class='label label-success'>printing 63%</span>
                        File 1 <i>ETP: 1hr 62m</i>
                    </li>
                    <li class='list-group-item'>
                        <span class='label label-primary'>slicing</span>
                        File 2
                        <button class='btn btn-default pull-right btn-xs'>
                            <span class='glyphicon glyphicon-remove'></span>
                        </button>
                    </li>
                    <li class='list-group-item'>
                        <span class='label label-primary'>heating 58%</span>
                        File 2
                        <button class='btn btn-default pull-right btn-xs'>
                            <span class='glyphicon glyphicon-remove'></span>
                        </button>
                    </li>
                    <li class='list-group-item'>
                        <span class='label label-primary'>waiting</span>
                        File 3
                        <button class='btn btn-default pull-right btn-xs'>
                            <span class='glyphicon glyphicon-remove'></span>
                        </button>
                    </li>
                -->
                </ul>


                <form role='form' class='form-inline'>
                    <div class='col-xs-9'>
                        <div class='input-group'>
                            <span class='input-group-btn'>
                                <span class='btn btn-default btn-file'>
                                    Select File <input type='file' id='fileinput'>
                                </span>
                            </span>
                            <input type='text' class='form-control' readonly id='filenames'>
                        </div>
                    </div>
                    <div class='col-xs-3'>
                        <button class='btn btn-primary' id='upload-file'>Add to Queue</button>
                    </div>
                </form>
                <!--
                <p>
                    currently loaded: <i class='current-file'>foo.stl</i>
                </p>
                <button class='btn btn-primary' id='start-print'>print</button>
            -->
            </div>
        </div>
    </div>
</div>

<div class='row mode-panel' id='heating-panel'>
    <div class='col-md-12'>
        <div class='panel panel-default'>
            <div class='panel-heading'>Heating</div>

            <div class='panel-body'>

                <h4>Slicing</h4>

                <div class="progress progress-striped">
                  <div id='slicing-progress' class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 40%">
                    <span class="sr-only">0% Complete (success)</span>
                  </div>
                </div>

                <h4>Temperature</h4>

                <div class="progress progress-striped">
                  <div id='heating-progress' class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 40%">
                    <span class="sr-only">0% Complete (success)</span>
                  </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class='row mode-panel' id='printing-panel'>
    <div class='col-md-12'>
        <div class='panel panel-default'>
            <h3 class='panel-heading'>Printing <i>foo.stl</i></h3>
            <div class='panel-body'>

                <div class='row'>
                    <div class='col-xs-4'>
                        <canvas id='layer-canvas' width='100' height='300'></canvas>
                    </div>
                    <div class='col-xs-8'>
                        <div class='row'>
                            <div class='col-xs-12 current-percent'>68%</div>
                        </div>
                        <div class='row'>
                            <div class='col-xs-12 current-layer'>layer 45 of 80</div>
                        </div>
                        <div class='row'>
                            <div class='col-xs-12 current-time-label'>time left</div>
                        </div>
                        <div class='row'>
                            <div class='col-xs-12 current-time-amount'>1h 30m 45sec</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class='panel-footer'>
                <button class='btn btn-primary'>pause</button>
                <button class='btn btn-danger'>cancel</button>
            </div>
        </div>
    </div>
</div>

<div class='row mode-panel' id='about-panel'>
    <div class='col-md-12'>
        <div class='panel panel-default'>
            <div class='panel-heading'>About OctoPlay</div>
            <div class='panel-body'>
                <p>cool OctoPrint logo goes here</p>
                <p>OctoPlay is a mockup of a potential future mobile-ready interface for OctoPrint</p>
                <p>OctoPlay was created by Mister Foo, Master Bar, and Mistress Quxx</p>

                <button class='btn btn-primary'>Check for OctoPlay Updates</button>
                <b>update available!</b>
            </div>
        </div>
    </div>
</div>

<div class='row mode-panel' id='settings-panel'>
    <div class='col-md-12'>
        <div class='panel panel-default'>
            <div class='panel-heading'>Printer Settings</div>

            <div class='panel-body'>
                <form class='form-horizontal' role='form'>
                    <div class='form-group'>
                        <label class='col-sm-4 control-label'>Filament Diameter</label>
                        <div   class='col-sm-6'>
                            <input type='text' class='form-control' placeholder='0.4mm'>
                        </div>
                    </div>
                    <div class='form-group'>
                        <label class='col-sm-4 control-label'>Nozzle Diameter</label>
                        <div   class='col-sm-6'>
                            <input type='text' class='form-control' placeholder='0.4mm'>
                        </div>
                    </div>
                    <div class='form-group'>
                        <label class='col-sm-4 control-label'>Print Speed</label>
                        <div   class='col-sm-6'>
                            <input type='text' class='form-control' placeholder='30mm/s'>
                        </div>
                    </div>
                    <div class='form-group'>
                        <label class='col-sm-4 control-label'>Layer Height</label>
                        <div   class='col-sm-6'>
                            <input type='text' class='form-control' placeholder='0.2mm'>
                        </div>
                    </div>
                    <div class='form-group'>
                        <label class='col-sm-4 control-label'>Calibration Constants</label>
                    <div   class='col-sm-2'>
                        <input type='text' class='form-control' placeholder='205'>
                    </div>
                    <div   class='col-sm-2'>
                        <input type='text' class='form-control' placeholder='408'>
                    </div>
                    <div   class='col-sm-2'>
                        <input type='text' class='form-control' placeholder='205'>
                    </div>
                    </div>
                    <div class='form-group'>
                        <label class='col-sm-4 control-label'>Firmware version</label>
                        <div   class='col-sm-6'>
                            <input type='text' class='form-control' placeholder='PrintrBot code 0.0.0.1'>
                        </div>
                    </div>

                </form>
            </div>


            <div class='panel-footer'>
                <button class='btn btn-success'>Calibrate..</button>
                <button class='btn btn-success'>Setup Dropbox</button>
                <button class='btn btn-primary'>Save Changes</button>
            </div>

        </div>
    </div>
</div>

<div class='row mode-panel' id='manual-panel'>
    <div class='col-md-12'>
        <div class='panel panel-default'>
            <div class='panel-heading'>Manual Control</div>
            <div class='panel-body'>
                <div class='col-xs-6'>
                    <div class='row'>
                        <div class='col-xs-4 col-xs-offset-4'>
                            <button class='btn btn-default' id='manual-up'><span class='glyphicon glyphicon-arrow-up'></span></button>
                        </div>
                    </div>
                    <div class='row'>
                        <div class='col-xs-4'><button class='btn btn-default' id='manual-left'><span class='glyphicon glyphicon-arrow-left'></span></button></div>
                        <div class='col-xs-4'><b>X and Y axis</b></div>
                        <div class='col-xs-4'><button class='btn btn-default' id='manual-right'><span class='glyphicon glyphicon-arrow-right'></span></button></div>
                    </div>
                    <div class='row'>
                        <div class='col-xs-4 col-xs-offset-4'>
                            <button class='btn btn-default' id='manual-down'><span class='glyphicon glyphicon-arrow-down'></span></button>
                        </div>
                    </div>

                    <div class='row'>
                        <div class='col-xs-12'><b>Z axis</b></div>
                    </div>
                    <div class='row'>
                        <div class='col-xs-12'>
                            <button class='btn btn-default' id='manual-upz'><span class='glyphicon glyphicon-arrow-up'></span></button>
                            <button class='btn btn-default' id='manual-downz'><span class='glyphicon glyphicon-arrow-down'></span></button>
                        </div>
                    </div>

                    <div class='row'>
                        <div class='col-xs-12'><b>Extruder Temperature</b></div>
                    </div>
                    <div class='row'>
                        <div class='col-xs-12'>
                            <select id='manual-temp' class='form-control'>
                                <option value='30'>30 C</option>
                                <option value='190'>190 C</option>
                                <option value='195'>195 C</option>
                                <option value='200'>200 C</option>
                                <option value='205'>205 C</option>
                                <option value='210'>210 C</option>
                            </select>
                        </div>
                    </div>

                    <div class='row'>
                        <div class='col-xs-12'><b>Home</b></div>
                    </div>
                    <div class='row'>
                        <div class='col-xs-12'>
                            <button class='btn btn-success' id='manual-home'>home</button>
                        </div>
                    </div>



                </div>


                <div class='col-xs-6'>
                    <p>estimates</p>
                    <dl class='dl-horizontal'>
                        <dt>x</dt><dd id='manual-status-x'>100mm</dd>
                        <dt>y</dt><dd id='manual-status-y'>100mm</dd>
                        <dt>z</dt><dd id='manual-status-z'>100mm</dd>
                        <dt>temp</dt><dd id='manual-status-temp'>100C</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

<div class='row mode-panel' id='camera-panel'>
    <div class='col-md-12'>
        <div class='panel panel-default'>
            <div class='panel-heading'>Camera</div>
            <div class='panel-body'>
                <p class='camera-preview'>cool camera preview goes here</p>
            </div>
        </div>
    </div>
</div>

        </div>
    </div>

</div>


    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="js/jquery.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>

<script type='text/javascript'>
var LIVE = true;

function startPrint() {
    $(".mode-panel").hide();
    $("#printing-panel").show();
}
function startHeat() {
    $("#sidebar-status-state").text("Heating");
    $(".mode-panel").hide();
    $("#heating-panel").show();
    $("#heating-progress").css('width','0%');
    $("#slicing-progress").css('width','0%');
    if(LIVE) {
        $.post('http://localhost:3589/print', function(result, status) {
            console.log("print = ",result);
            console.log("target temp reached");
            $("#heating-progress").css('width','100%');
            $("#slicing-progress").css('width','100%');
            startPrint();
        });
    } else {
        setTimeout(function() {
            $("#slicing-progress").css('width','100%');
            $("#heating-progress").css('width','50%');
            //startPrint();
        },1000);
        setTimeout(function() {
            $("#heating-progress").css('width','100%');
            setTimeout(startPrint,1000);
        },2000);
    }

}
function toggle(id) {
    return function(e) {
        e.preventDefault();
        $(".mode-panel").hide();
        $(id).show();
    }
}

var STATUS = {
    x:-1,
    y:-1,
    z:-1,
    temp:-1,
    file:"foo.stl",
}

function updateStatus() {
    $("#manual-status-x").text(STATUS.x+'mm');
    $("#manual-status-y").text(STATUS.y+'mm');
    $("#manual-status-z").text(STATUS.z+'mm');
    $("#manual-status-temp").text(STATUS.temp+"C");
    $("#sidebar-status-temp").text(STATUS.temp+"C");
}

function move(name,val) {
    var args = {};
    args[name] = val;
    $.post('http://localhost:3589/move',args, function(result, status) {
        STATUS[name] = result[name];
        updateStatus();
    });
}


function moveLeft() {  move('x',STATUS.x-5); };
function moveRight() { move('x',STATUS.x+5); };
function moveUp() {    move('y',STATUS.y+5); };
function moveDown() {  move('y',STATUS.y-5); };
function moveUpZ() {   move('z',STATUS.z+5); };
function moveDownZ() { move('z',STATUS.z-5); };

function moveHome() {
    var args = {};
    $.post('http://localhost:3589/home',args, function(result, status) {
        console.log("result = ",result,status);
        getPrinterStatus();
    });
}

function getPrinterStatus() {
    $.get("http://localhost:3589/status",function(result,status) {
        STATUS.x = parseFloat(result.x);
        STATUS.y = result.y;
        STATUS.z = result.z;
        STATUS.e = result.e;
        STATUS.temp = result.temp;
        updateStatus();
    });
}

function setTargetTemp(temp) {
    var args = { temp: temp };
    $.post('http://localhost:3589/temp',args, function(result, status) {
        console.log("result = ",result,status);
    });
}

function getPrintQueue() {
    $.get("http://localhost:3589/queue",function(result,status) {
        console.log("got the print queue ",result.queue);
        var out = Mustache.render($("#print-queue-item-template").text(), result);
        console.log("rendered",out);

        $(".print-queue").empty().append(out);
    });

}
function uploadFile(e) {
    e.preventDefault();
    var fileinput = $("#fileinput")[0];
    console.log("file input = ", fileinput.files[0]);
    var data = new FormData();
    data.append('stlfile',fileinput.files[0]);
    $.ajax({
        url:"http://localhost:3589/upload",
        type:'POST',
        data:data,
        processData:false,
        contentType:false,
    }).done(function(result) {
        console.log("upload:",result);
        getPrintQueue();
    });
};



$(document).ready(function() {
    $(".mode-panel").hide();
    $("#standby-panel").show();
    //$("#printing-panel").show();

    $("#start-print").click(startHeat);
    $("#login-menu").click(toggle('#login-panel'));
    $("#about-menu").click(toggle('#about-panel'));
    $("#manual-menu").click(toggle('#manual-panel'));
    $("#settings-menu").click(toggle('#settings-panel'));
    $("#camera-menu").click(toggle('#camera-panel'));
    $("#home-menu").click(toggle('#standby-panel'));
    fillLayers();

    if(LIVE) {
        $("#manual-left").click(moveLeft);
        $("#manual-right").click(moveRight);
        $("#manual-up").click(moveUp);
        $("#manual-down").click(moveDown);
        $("#manual-upz").click(moveUpZ);
        $("#manual-downz").click(moveDownZ);
        $("#manual-home").click(moveHome);
        $("#manual-temp").change(function() {
            setTargetTemp(parseFloat($(this).val()));
        });

        //===== websocket monitoring
        var wsurl = "ws:localhost:4202";
        monitor = new WebSocket(wsurl);
        monitor.onopen = function(e) {
            console.log("opened the websocket for ",wsurl);
        }
        monitor.onclose = function(e) {
            console.log("closed websocket");
        }
        monitor.onerror = function(e) {
            console.log("error in websocket");
        }
        monitor.onmessage = function(e) {
            var mess = JSON.parse(e.data);
            if(mess.type == 'temp') {
                STATUS.temp = parseFloat(mess.value);
                updateStatus();
                return;
            }
            console.log("got a message",mess);
            if(mess.type == 'state') {
                $("#sidebar-status-state").text(mess.value);
            }
        }



        //get the initial status
        getPrinterStatus();
        getPrintQueue();

        // ===== file upload stuff
        $(document).on('change', '.btn-file :file', function() {
                var input = $(this),
                    numFiles = input.get(0).files ? input.get(0).files.length : 1,
                    label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
                input.trigger('fileselect', [numFiles, label]);
        });
        $('.btn-file :file').on('fileselect', function(event, numFiles, label) {
            console.log('file count',numFiles);
            console.log('names',label);
            var input = $(this).parents('.input-group').find(':text');
            var log = numFiles > 1 ? numFiles + ' files selected' : label;
            input.val(log);
        });
        $("#upload-file").click(uploadFile);



    }



});


function fillLayers() {
    var ctx = $("#layer-canvas")[0].getContext('2d');
    ctx.fillStyle = '#000000';
    ctx.fillRect(0,0, 100,300);
    ctx.strokeStyle = '#ff9999';
    ctx.fillStyle = '#cc4444';

    var maxlayers = 60;
    var layerwidth = Math.floor(300/maxlayers);
    for(var i=0; i<45; i++) {
        ctx.fillRect(1,       300-i*(layerwidth),     100-2, layerwidth-2);
        ctx.strokeRect(1+0.5, 300-i*(layerwidth)+0.5, 100-3, layerwidth-2);
    }
}
    </script>

  </body>
  <script src='js/mustache.js'></script>
<script type='text/mustache-template' id='print-queue-item-template'>
{{#queue}}
<li class='list-group-item' data-itemid='{{id}}'>
    <button class='btn btn-default pull-right btn-xs'>
        <span class='glyphicon glyphicon-remove'></span>
    </button>
    <span class='label label-success'>{{state}}</span>
    {{name}}
    <i>{{eta}}</i>
</li>
{{/queue}}

</script>

</html>
