<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>OctoPlay</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type='text/css'>
        .camera-preview {
            border: 1px solid black;
            width: 200px;
            height:200px;
        }
        .current-layer {
            font-size: 150%;
            text-align: center;
        }
        .current-percent {
            font-size: 500%;
            text-align: center;
        }
        .current-time-label {
            font-size: 100%;
            text-align: center;
        }
        .current-time-amount {
            font-size: 200%;
            text-align: center;
        }




        /* == start file upload stuff */
        .btn-file {
            position: relative;
            overflow: hidden;
        }
        .btn-file input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 999px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            background: white;
            cursor: inherit;
            display: block;
        }
        /* == end file upload stuff */

    </style>
  </head>
  <body>

<!-- ============== Modals ============ -->
<div class="modal fade" id='add-queue-dialog'>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Add STL File to Queue</h4>
      </div>
      <div class="modal-body">

        <form role='form' class='form-horizontal' id='add-queue-form'>
            <div class='form-group'>
                <label class='col-sm-2 control-label'>Model</label>
                <div class='input-group'>
                    <span class='input-group-btn'>
                        <span class='btn btn-default btn-file'>
                            Select File <input type='file' id='fileinput'>
                        </span>
                    </span>
                    <input type='text' class='form-control' readonly id='filenames'>
                </div>
            </div>
            <div class='form-group'>
                <label class='col-sm-2 control-label'>Speed</label>

                <div class="btn-group" data-toggle="buttons">
                  <label class="btn btn-default active">
                    <input type="radio" name="options" id="option1" value='low' checked='true'> Low Quality / Fast
                  </label>
                  <label class="btn btn-default">
                    <input type="radio" name="options" id="option2" value='high'> High Quality / Slow
                  </label>
                </div>

            </div>
            <div class='form-group'>
                <label class='col-sm-2 control-label'>Mode</label>
                <div class='btn-group' data-toggle='buttons'>
                    <label class='btn btn-default active'>
                        <input type='radio' value='normal' name='rim-mode' checked='true'>Normal
                    </label>
                    <label class='btn btn-default'>
                        <input type='radio' value='vase'   name='rim-mode'>Vase
                    </label>
                </div>
            </div>
        </form>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id='add-to-queue'>Add to Queue</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->





<nav class='navbar navbar-default' role='navigation'>
    <div class='container-fluid'>
        <div class='navbar-header'>
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navdown">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <span class="navbar-brand">OctoPlay</span>
            <p class='navbar-text'>
                <b class='sidebar-status-temp'>-99C</b> <b class='sidebar-status-state label label-default'>standby</b>
            </p>

        </div>


        <div class="collapse navbar-collapse" id="navdown">

          <ul class="nav navbar-nav navbar-right">
              <li><a href="#" id='login-menu'>Login</a></li>
              <li><a href="#" id='home-menu'>Home</a></li>
              <li><a href="#" id='manual-menu'>Manual Control</a></li>
              <li><a href="#" id='camera-menu'>Camera</a></li>
              <li><a href="#" id='settings-menu'>Settings</a></li>
              <li><a href="#" id='about-menu'>About OctoPlay</a></li>
          </ul>
      </div>

    </div>
</nav>



<div class='container-fluid'>

    <div class='row'>

<!-- ========= SIDEBAR =========== -->
<!--
<div class='col-md-4'>
    <div class='panel panel-default'>
        <p>current temp: <b class='sidebar-status-temp'>-99C</b></p>
        <p>state: <b class='sidebar-status-state'>standby</b></p>
    </div>
</div>
-->

        <div class='col-md-8'>

<div class='row'>
    <div class='col-md-12'>
<ul class='list-group' id='print-current'>
    <li class='list-group-item'>
        <button id='cancel-print' class='btn btn-danger pull-right' disabled>Cancel</button>
        <button id='pause-print' class='btn btn-primary pull-right' disabled>Pause</button>
        <span class='label label-primary state'>foo</span><br/>
        filename: <b class='filename'>Awesome.stl</b><br/>
        time left: <b class='timeleft'>8hrs 2min</b><br/>

        <div class='row'>
            <div class='col-xs-3'>Temp:</div>
            <div class='col-xs-9'>
                <div class='progress'>
                    <div class='progress-bar temp-bar progress-bar-danger' role='progressbar' style='width:0%;'>0%</div>
                </div>
            </div>
        </div>

        <div class='row'>
            <div class='col-xs-3'>Complete:</div>
            <div class='col-xs-9'>
                <div class='progress'>
                    <div class='progress-bar print-bar' role='progressbar' style='width:0%;'>0%</div>
                </div>
            </div>
        </div>
    </li>
</ul>
    </div>
</div>

<div class='row mode-panel' id='main-panel'>
    <div class='col-md-12'>
        <div class='panel panel-default'>
            <div class='panel-heading'>Print Queue</div>
            <div class='panel-body'>


                <button id='print-next' class='btn btn-primary'>Print Next</button>

                <ul class='list-group print-queue'>
                </ul>

                <button id='add-to-queue' class='btn btn-primary'
                    data-toggle='modal' data-target='#add-queue-dialog'>Add to Queue</button>
            </div>
        </div>
    </div>
</div>


<div class='row mode-panel' id='about-panel'>
    <div class='col-md-12'>
        <div class='panel panel-default'>
            <div class='panel-heading'>About OctoPlay</div>
            <div class='panel-body'>
                <p>cool OctoPrint logo goes here</p>
                <p>OctoPlay is a mockup of a potential future mobile-ready interface for OctoPrint</p>
                <p>OctoPlay was created by Mister Foo, Master Bar, and Mistress Quxx</p>

                <button class='btn btn-primary'>Check for OctoPlay Updates</button>
                <b>update available!</b>
            </div>
        </div>
    </div>
</div>

<div class='row mode-panel' id='settings-panel'>
    <div class='col-md-12'>
        <div class='panel panel-default'>
            <div class='panel-heading'>Printer Settings</div>

            <div class='panel-body'>
                <form class='form-horizontal' role='form'>
                    <div class='form-group'>
                        <label class='col-sm-4 control-label'>Filament Diameter</label>
                        <div   class='col-sm-6'>
                            <input type='text' class='form-control' placeholder='0.4mm'>
                        </div>
                    </div>
                    <div class='form-group'>
                        <label class='col-sm-4 control-label'>Nozzle Diameter</label>
                        <div   class='col-sm-6'>
                            <input type='text' class='form-control' placeholder='0.4mm'>
                        </div>
                    </div>
                    <div class='form-group'>
                        <label class='col-sm-4 control-label'>Print Speed</label>
                        <div   class='col-sm-6'>
                            <input type='text' class='form-control' placeholder='30mm/s'>
                        </div>
                    </div>
                    <div class='form-group'>
                        <label class='col-sm-4 control-label'>Layer Height</label>
                        <div   class='col-sm-6'>
                            <input type='text' class='form-control' placeholder='0.2mm'>
                        </div>
                    </div>
                    <div class='form-group'>
                        <label class='col-sm-4 control-label'>Calibration Constants</label>
                    <div   class='col-sm-2'>
                        <input type='text' class='form-control' placeholder='205'>
                    </div>
                    <div   class='col-sm-2'>
                        <input type='text' class='form-control' placeholder='408'>
                    </div>
                    <div   class='col-sm-2'>
                        <input type='text' class='form-control' placeholder='205'>
                    </div>
                    </div>
                    <div class='form-group'>
                        <label class='col-sm-4 control-label'>Firmware version</label>
                        <div   class='col-sm-6'>
                            <input type='text' class='form-control' placeholder='PrintrBot code 0.0.0.1'>
                        </div>
                    </div>

                </form>
            </div>


            <div class='panel-footer'>
                <button class='btn btn-success'>Calibrate..</button>
                <button class='btn btn-success'>Setup Dropbox</button>
                <button class='btn btn-primary'>Save Changes</button>
            </div>

        </div>
    </div>
</div>

<div class='row mode-panel' id='manual-panel'>
    <div class='col-md-12'>
        <div class='panel panel-default'>
            <div class='panel-heading'>Manual Control</div>
            <div class='panel-body'>
                <div class='col-xs-6'>
                    <div class='row'>
                        <div class='col-xs-4 col-xs-offset-4'>
                            <button class='btn btn-default' id='manual-up'><span class='glyphicon glyphicon-arrow-up'></span></button>
                        </div>
                    </div>
                    <div class='row'>
                        <div class='col-xs-4'><button class='btn btn-default' id='manual-left'><span class='glyphicon glyphicon-arrow-left'></span></button></div>
                        <div class='col-xs-4'><b>X and Y axis</b></div>
                        <div class='col-xs-4'><button class='btn btn-default' id='manual-right'><span class='glyphicon glyphicon-arrow-right'></span></button></div>
                    </div>
                    <div class='row'>
                        <div class='col-xs-4 col-xs-offset-4'>
                            <button class='btn btn-default' id='manual-down'><span class='glyphicon glyphicon-arrow-down'></span></button>
                        </div>
                    </div>

                    <div class='row'>
                        <div class='col-xs-12'><b>Z axis</b></div>
                    </div>
                    <div class='row'>
                        <div class='col-xs-12'>
                            <button class='btn btn-default' id='manual-upz'><span class='glyphicon glyphicon-arrow-up'></span></button>
                            <button class='btn btn-default' id='manual-downz'><span class='glyphicon glyphicon-arrow-down'></span></button>
                        </div>
                    </div>

                    <div class='row'>
                        <div class='col-xs-12'><b>Extruder Temperature</b></div>
                    </div>
                    <div class='row'>
                        <div class='col-xs-12'>
                            <select id='manual-temp' class='form-control'>
                                <option value='30'>30 C</option>
                                <option value='50'>50 C</option>
                                <option value='190'>190 C</option>
                                <option value='195'>195 C</option>
                                <option value='200'>200 C</option>
                                <option value='205'>205 C</option>
                                <option value='210'>210 C</option>
                            </select>
                        </div>
                    </div>

                    <div class='row'>
                        <div class='col-xs-12'><b>Home</b></div>
                    </div>
                    <div class='row'>
                        <div class='col-xs-12'>
                            <button class='btn btn-success' id='manual-home'>home</button>
                        </div>
                    </div>



                </div>


                <div class='col-xs-6'>
                    <p>estimates</p>
                    <dl class='dl-horizontal'>
                        <dt>x</dt><dd id='manual-status-x'>100mm</dd>
                        <dt>y</dt><dd id='manual-status-y'>100mm</dd>
                        <dt>z</dt><dd id='manual-status-z'>100mm</dd>
                        <dt>temp</dt><dd id='manual-status-temp'>100C</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

<div class='row mode-panel' id='camera-panel'>
    <div class='col-md-12'>
        <div class='panel panel-default'>
            <div class='panel-heading'>Camera</div>
            <div class='panel-body'>
                <p class='camera-preview'>cool camera preview goes here</p>
            </div>
        </div>
    </div>
</div>

        </div>
    </div>

</div>


    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="js/jquery.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>

<script type='text/javascript'>
var LIVE = true;

function toggle(id) {
    return function(e) {
        e.preventDefault();
        $(".mode-panel").hide();
        $(id).show();
    }
}

var STATUS = {
    x:-1,
    y:-1,
    z:-1,
    temp:-1,
    file:"foo.stl",
}

function updateStatus() {
    $("#manual-status-x").text(STATUS.x+'mm');
    $("#manual-status-y").text(STATUS.y+'mm');
    $("#manual-status-z").text(STATUS.z+'mm');
    $("#manual-status-temp").text(STATUS.temp+"C");
    $(".sidebar-status-temp").text(STATUS.temp+"C");

    var per = STATUS.temp/STATUS.temptarget;
    var diff = Math.abs(STATUS.temptarget - STATUS.temp);
    //console.log("per = ",per,1.0-(diff/200));
    var pper = 1.0-(diff/200);
    var tempper = (pper*100).toFixed(1) + "%";
    $("#print-current .temp-bar").css('width',tempper);
    $("#print-current .temp-bar").text(tempper);
}

function updateProgress(mess) {
    var percent = parseFloat(mess.linesleft)/parseFloat(mess.totallines) * 100.0;
    var printper = (100-percent).toFixed(1)+"%";
    console.log("per = ",printper);
    $("#print-current .print-bar").css('width',printper);
    $("#print-current .print-bar").text(printper);
}

function move(name,val) {
    var args = {};
    args[name] = val;
    $.post('http://localhost:3589/move',args, function(result, status) {
        STATUS[name] = result[name];
        updateStatus();
    });
}


var server = {

    setup: function() {
        //===== websocket monitoring
        var wsurl = "ws:localhost:4202";
        var monitor = new WebSocket(wsurl);
        monitor.onopen = function(e) {
            console.log("opened the websocket for ",wsurl);
        }
        monitor.onclose = function(e) {
            console.log("closed websocket");
        }
        monitor.onerror = function(e) {
            console.log("error in websocket");
        }
        monitor.onmessage = function(e) {
            var mess = JSON.parse(e.data);
            if(mess.type == 'temp') {
                //console.log(mess);
                STATUS.temp = parseFloat(mess.value);
                STATUS.temptarget = parseFloat(mess.target);
                updateStatus();
                return;
            }
            if(mess.type == 'okay') {
                console.log(" a command finished.", mess.totallines, mess.linesleft);
                if(mess.totallines && mess.linesleft) {
                    updateProgress(mess);
                }
            }
            console.log("got a message",mess);
            if(mess.type == 'state') {
                $(".sidebar-status-state").text(mess.value);
                $("#print-current .state").text(mess.value);
            }
        }

        $("#print-current .state").text('standby');
        $("#print-current .filename").text('');
        $("#print-current .timeleft").text('');
        $("#print-current .complete").text('');

    },
    moveLeft:  function() { move('x',STATUS.x-5); },
    moveRight: function() { move('x',STATUS.x+5); },
    moveUp:    function() { move('y',STATUS.y+5); },
    moveDown:  function() { move('y',STATUS.y-5); },
    moveUpZ:   function() { move('z',STATUS.z+5); },
    moveDownZ: function() { move('z',STATUS.z-5); },
    moveHome:  function() {
        var args = {};
        $.post('http://localhost:3589/home',args, function(result, status) {
            console.log("result = ",result,status);
            server.getPrinterStatus();
        });
    },
    getPrinterStatus: function() {
        $.get("http://localhost:3589/status",function(result,status) {
            STATUS.x = parseFloat(result.x);
            STATUS.y = result.y;
            STATUS.z = result.z;
            STATUS.e = result.e;
            STATUS.temp = result.temp;
            updateStatus();
        });
    },
    setTargetTemp: function(temp) {
        var args = { temp: temp };
        $.post('http://localhost:3589/temp',args, function(result, status) {
            console.log("result = ",result,status);
        });
    },
    addToQueue: function() {
        var form = document.getElementById('add-queue-form');
        var data = new FormData(form);
        data.append('stlfile',$("#fileinput")[0].files[0]);
        $.ajax({
            url:"http://localhost:3589/upload",
            type:'POST',
            data:data,
            processData:false,
            contentType:false,
        }).done(function(result) {
            $("#add-queue-dialog").modal('hide');
            server.getPrintQueue();
        });
    },

    getPrintQueue: function() {
        $.get("http://localhost:3589/queue",function(result,status) {
            console.log("got the print queue ",result.queue);
            var out = Mustache.render($("#print-queue-item-template").text(), result);
            console.log("rendered",out);
            $(".print-queue").empty().append(out);
        });
    },
    printNext: function() {
        console.log("printing next thing in the queue");
        $.post("http://localhost:3589/print", function(result,status) {
            console.log("requested the first thing in the queue to be printed",result);
            updateCurrentStatus(result.item);
            server.getPrintQueue();
        });
    }

}

var fakeServer = {

    current_print: {
        name:'active.stl',
        id:'blah',
        state:'waiting',
        eta:'1hr 30min',
        percent:50,
    },

    print_queue: [
        {
            name:'robot.stl',
            id:'foo',
            state:'printing',
            eta:'1hr 30min',
        },
        {
            name:'plate.stl',
            id:'plate',
            state:'waiting',
            eta:'8hr 16min',
        },
    ],

    setup: function() {
        $("#print-current .state").text('standby');
        $("#print-current .filename").text('');
        $("#print-current .timeleft").text('');
        $("#print-current .complete").text('');
    },

    moveLeft:     function() { STATUS.x -= 5; updateStatus(); },
    moveRight:    function() { STATUS.x += 5; updateStatus(); },
    moveUp:       function() { STATUS.y += 5; updateStatus(); },
    moveDown:     function() { STATUS.y -= 5; updateStatus(); },
    moveDownZ:    function() { STATUS.z -= 5; updateStatus(); },
    moveUpZ:      function() { STATUS.z += 5; updateStatus(); },
    moveHome:     function() {
        STATUS.x = 0;
        STATUS.y = 0;
        STATUS.z = 0;
        updateStatus();
    },
    getPrinterStatus: function() {
        //no-op
    },
    setTargetTemp: function(temp) {
        var id = setInterval(function() {
            if(Math.abs(STATUS.temp-temp) < 10) {
                STATUS.temp = temp;
                updateStatus();
                clearInterval(id);
                return;
            }
            if(STATUS.temp > temp) {
                STATUS.temp -= 10;
            } else {
                STATUS.temp += 10;
            }
            updateStatus();
        },500);
    },
    addToQueue: function() {
        console.log("adding to queue");
        $("#add-queue-dialog").modal('hide');
        server.print_queue.push({
            name:'foo',
            id:'foo',
            state:'slicing',
            eta:10*10*60,
        });
        server.getPrintQueue();
    },
    getPrintQueue: function() {
        var out = Mustache.render($("#print-queue-item-template").text(), {queue:server.print_queue});
        $(".print-queue").empty().append(out);
    },

    printNext: function() {
        console.log("pretending to print the next one");
        server.current_print = server.print_queue.shift();
        $("#pause-print").removeAttr('disabled');
//        <button id='pause-print' class='btn btn-danger pull-right' disabled>Cancel</button>
//        <button id='cancel-print' class='btn btn-primary pull-right' disabled>Pause</button>

        server.current_print.percent = 0;
        server.getPrintQueue();
        setTimeout(simulateHeating,1000);
    },

}

$("#pause-print").click(function() {
    if(server.current_print.state == 'printing') {
        server.current_print.state = 'paused';
        $("#pause-print").text("resume");
        $("#cancel-print").removeAttr('disabled');
    } else {
        server.current_print.state = 'printing';
        $("#pause-print").text("pause");
        $("#cancel-print").attr('disabled','disabled');
    }
})

function simulateHeating() {
    server.current_print.state = 'heating';
    STATUS.temp = 25;
    updateCurrentStatus(server.current_print);

    var id = setInterval(function() {
        STATUS.temp += 6.7;
        updateCurrentStatus(server.current_print);
        if(STATUS.temp >= 195) {
            clearInterval(id);
            simulatePrinting();
        }
    },250);
}

function simulatePrinting() {
    server.current_print.state = 'printing';
    STATUS.temp = 195;
    updateCurrentStatus(server.current_print);
    var id = setInterval(function() {
        server.current_print.percent +=5;
        updateCurrentStatus(server.current_print);
        if(server.current_print.percent >= 100) {
            clearInterval(id);
            server.current_print.state = 'done!';
            $("#pause-print").text('reprint');
            $("#cancel-print").attr('disabled','disabled');
            updateCurrentStatus(server.current_print);
        }
    },250);
}

function updateCurrentStatus(current) {
    $("#print-current .state")   .text(current.state);
    $("#print-current .filename").text(current.name);
    $("#print-current .timeleft").text(current.eta);
    $("#print-current .complete").text(current.percent+"%");

    var printper = current.percent+"%";
    $("#print-current .print-bar").css('width',printper);
    $("#print-current .print-bar").text(printper);
    var tempper = ((STATUS.temp/195.0)*100).toFixed(0) + "%";
    $("#print-current .temp-bar").css('width',tempper);
    $("#print-current .temp-bar").text(tempper);
    $(".sidebar-status-state").text(current.state);
    $(".sidebar-status-temp").text(STATUS.temp.toFixed(2)+"C");
}



$(document).ready(function() {
    if(!LIVE) {
        server = fakeServer;
    }

    $(".mode-panel").hide();
    $("#main-panel").show();

    //$("#start-print").click(startHeat);
    $("#login-menu").click(toggle('#login-panel'));
    $("#about-menu").click(toggle('#about-panel'));
    $("#manual-menu").click(toggle('#manual-panel'));
    $("#settings-menu").click(toggle('#settings-panel'));
    $("#camera-menu").click(toggle('#camera-panel'));
    $("#home-menu").click(toggle('#main-panel'));

    $("#print-next").click(server.printNext);

    //fillLayers();

    $("#manual-left").click(server.moveLeft);
    $("#manual-right").click(server.moveRight);
    $("#manual-up").click(server.moveUp);
    $("#manual-down").click(server.moveDown);
    $("#manual-upz").click(server.moveUpZ);
    $("#manual-downz").click(server.moveDownZ);
    $("#manual-home").click(server.moveHome);
    $("#manual-temp").change(function() { server.setTargetTemp(parseFloat($(this).val()));  });

    // ===== file upload stuff
    $(document).on('change', '.btn-file :file', function() {
            var input = $(this),
                numFiles = input.get(0).files ? input.get(0).files.length : 1,
                label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
            input.trigger('fileselect', [numFiles, label]);
    });
    $('.btn-file :file').on('fileselect', function(event, numFiles, label) {
        console.log('file count',numFiles);
        console.log('names',label);
        var input = $(this).parents('.input-group').find(':text');
        var log = numFiles > 1 ? numFiles + ' files selected' : label;
        input.val(log);
    });

    $("#add-to-queue").click(server.addToQueue);

    if(LIVE) {

    }

    server.setup();
    server.getPrinterStatus();
    server.getPrintQueue();

});


    </script>



  </body>

<script src='js/mustache.js'></script>


<!-- =========== Mustache Templates ============== -->
<script type='text/mustache-template' id='print-queue-item-template'>
    {{#queue}}
        <li class='list-group-item' data-itemid='{{id}}'>
            <button class='btn btn-default pull-right btn-xs'>
                <span class='glyphicon glyphicon-remove'></span>
            </button>
            filename: <b>{{name}}</b><br/>
            estimated print time: <b>{{eta}}</b><br/>
        </li>
    {{/queue}}
</script>

</html>
